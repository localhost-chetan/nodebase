# ---------- Stage 1: Builder ----------
FROM oven/bun:1.3.6-alpine AS builder

WORKDIR /app

# Copy dependency manifests
COPY package.json bun.lock ./

# Install all dependencies (including dev) for build-time tools
RUN bun install

# Copy full source
COPY . .

# Provide a dummy DATABASE_URL for the build step (it doesn't actually connect)
ARG DUMMY_DATABASE_URL=postgresql://username:password@hostname:port/dbname
ENV DATABASE_URL=$DUMMY_DATABASE_URL

# Generate drizzle files
RUN bun run db:generate

# Build the app for production (outputs JS files to /app/out)
RUN bun run build


# ---------- Stage 2: Runtime ----------
FROM oven/bun:1.3.6-alpine AS runtime
WORKDIR /app

# Add a non-root user and group for security
RUN addgroup -S nodebase && adduser -S -G nodebase localhost-chetan

# Copy dependency manifests
COPY --from=builder /app/package.json ./
COPY --from=builder /app/bun.lock ./

# Install ONLY production dependencies for a lean image
RUN bun install --production

# Copy only whatâ€™s needed to run the app from the builder stage
COPY --from=builder /app/out/ ./out
COPY --from=builder /app/start.sh ./
COPY --from=builder /app/drizzle/ ./drizzle

# Add curl utility
RUN apk add --no-cache curl

# Change ownership of the app directory to the non-root user
RUN chown --recursive localhost-chetan:nodebase /app

# Give execute permission to the start script
RUN chmod 770 ./start.sh

# Switch to the non-root user
USER localhost-chetan

EXPOSE 3002

CMD ["./start.sh"]